<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sticker Notes App</title>
    <link rel="shortcut icon" type="image/png" href="https://placehold.co/32x32/764ba2/ffffff?text=SN">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.1);
        }
        
        .sticker-note {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(148, 163, 184, 0.2); 
            border-left-width: 5px; 
            position: relative; 
            min-height: 160px; 
            max-height: 280px; 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: grab; 
            /* MODIFIED: Adjusted padding for better spacing */
            padding: 1rem; /* Uniform padding of 1rem (16px) */
            /* margin-bottom is now handled by space-y-4 on the parent column */
        }

        .sticker-note.dragging { 
            opacity: 0.5;
            border-style: dashed;
        }
        /* NEW: Drop indicator line style */
        .drop-indicator-line {
            height: 2px;
            background-color: #9ca3af; /* Tailwind gray-400 */
            margin: 2px 0; /* Space around the line */
            border-radius: 1px;
        }
        
        .sticker-note:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-right-color: rgba(99, 102, 241, 0.3);
            border-top-color: rgba(99, 102, 241, 0.3);
            border-bottom-color: rgba(99, 102, 241, 0.3);
        }
        
        .sticker-actions {
            position: absolute;
            top: 8px; 
            right: 8px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transform: translateX(10px);
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .sticker-note:hover .sticker-actions {
            opacity: 1;
            transform: translateX(0);
        }
        
        .action-button {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        
        .action-button:hover::before {
            left: 100%;
        }
        
        .primary-button {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
        
        .primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.6);
        }
        
        .primary-button:disabled {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }
        
        .edit-button {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
        }
        
        .edit-button:hover {
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.6);
            transform: translateY(-1px);
        }
        
        .delete-button {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }
        
        .delete-button:hover {
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.6);
            transform: translateY(-1px);
        }
        
        .save-edit-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .cancel-button {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.4);
        }
        
        .input-field {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(148, 163, 184, 0.2);
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .input-field:focus {
            background: rgba(255, 255, 255, 0.95);
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content { 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        .edit-sticker-modal-content, .search-results-modal-content {
            max-width: 600px; 
            width: 90%; 
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        .floating-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
            animation: notificationSlide 0.4s ease forwards;
            z-index: 1001;
            font-weight: 500;
        }

        .floating-notification.hide {
            animation: notificationSlideOut 0.4s ease forwards;
        }
        
        @keyframes notificationSlide {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes notificationSlideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        
        .counter-badge {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            font-weight: 600;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }
        
        .scrollbar-custom {
            scrollbar-width: thin;
            scrollbar-color: rgba(99, 102, 241, 0.3) transparent;
        }
        
        .scrollbar-custom::-webkit-scrollbar { width: 6px; }
        .scrollbar-custom::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-custom::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.3); border-radius: 3px; }
        .scrollbar-custom::-webkit-scrollbar-thumb:hover { background: rgba(99, 102, 241, 0.5); }
        
        .title-gradient {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .importance-level-1 { border-left-color: #22c55e; } .importance-level-2 { border-left-color: #4ade80; }  
        .importance-level-3 { border-left-color: #84cc16; } .importance-level-4 { border-left-color: #a3e635; }  
        .importance-level-5 { border-left-color: #facc15; } .importance-level-6 { border-left-color: #fbbf24; }  
        .importance-level-7 { border-left-color: #f97316; } .importance-level-8 { border-left-color: #ea580c; }  
        .importance-level-9 { border-left-color: #dc2626; } .importance-level-10 { border-left-color: #b91c1c; }

        .sticker-bg-0 { background-color: #fef9c3; } .sticker-bg-1 { background-color: #dbeafe; }
        .sticker-bg-2 { background-color: #e0f2fe; } .sticker-bg-3 { background-color: #fee2e2; }
        .sticker-bg-4 { background-color: #fbcfe8; } .sticker-bg-5 { background-color: #ede9fe; }
        .sticker-bg-6 { background-color: #d1fae5; } .sticker-bg-7 { background-color: #e0f7fa; }
        .sticker-bg-8 { background-color: #f3e8ff; } .sticker-bg-9 { background-color: #fff7ed; }
        .sticker-bg-10 { background-color: #e2e8f0; } .sticker-bg-11 { background-color: #ccfbf1; }
        .sticker-bg-12 { background-color: #f0fdf4; } .sticker-bg-13 { background-color: #ecfdf5; }
        .sticker-bg-14 { background-color: #f0f9ff; } .sticker-bg-15 { background-color: #fdf2f8; }

        .sticker-content-text {
            white-space: pre-wrap; 
            word-break: break-word; 
            /* Kept hidden as per previous request to remove scrollbar from main stickers */
            overflow-y: hidden; 
            max-height: 120px; 
            line-height: 1.4; 
        }

        .sticker-timestamp {
            position: absolute;
            bottom: 6px;
            right: 8px;
            font-size: 0.7rem; 
            color: #6b7280; 
            z-index: 5;
        }
        .search-result-item {
            border-bottom: 1px solid #e5e7eb; 
            padding-bottom: 0.75rem; 
            margin-bottom: 0.75rem; 
            cursor: pointer; /* Make results clickable */
        }
        .search-result-item:last-child { border-bottom: none; margin-bottom: 0; }
        .search-modal-body { max-height: 70vh; overflow-y: auto; }
        /* MODIFIED: Re-enabled vertical scrollbar for search result content */
        .search-result-content {
            max-height: 100px; /* Or your preferred height */
            overflow-y: auto; /* Changed from hidden to auto */
            scrollbar-width: thin; /* For Firefox */
            scrollbar-color: rgba(156, 163, 175, 0.5) transparent; /* gray-400 */
        }
        /* Re-enabled scrollbar for Chrome, Safari and Opera */
        .search-result-content::-webkit-scrollbar { 
            width: 5px; /* Re-added width */
            display: block; /* Changed from none to block */
        }
        .search-result-content::-webkit-scrollbar-thumb { 
            background-color: rgba(156, 163, 175, 0.5); 
            border-radius: 3px;
        }

        /* NEW: Sticker highlight effect */
        @keyframes stickerHighlight {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); } /* indigo-500 with alpha */
            70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
        .sticker-highlight-effect {
            animation: stickerHighlight 1s ease-out;
        }

        /* Page button drag styles */
        #pagesContainer .action-button { cursor: grab; }
        #pagesContainer .action-button.dragging { opacity: 0.5; border-style: dashed; }
        .page-drop-indicator-line {
            width: 2px; /* Vertical line */
            height: 24px; /* Match button height approx */
            background-color: #9ca3af;
            margin: 0 2px; 
            border-radius: 1px;
        }


    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="glass-card p-8 rounded-3xl w-full" style="max-width: 1680px;">
        
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="space-y-6">
                <div class="text-center">
                    <h1 class="text-3xl title-gradient mb-2">Sticker Notes</h1>
                    <p class="text-gray-600 text-sm">Organize your daily work messages</p>
                </div>
                
                <div class="bg-white p-4 rounded-2xl shadow-md border border-gray-200">
                    <div id="pagesContainer" class="flex flex-wrap gap-2 mb-4 items-center"></div> <div class="flex gap-2">
                        <input type="text" id="newPageNameInput" class="input-field flex-1 p-2 rounded-xl focus:outline-none text-sm" placeholder="New page name..." maxlength="20"/>
                        <button id="addPageButton" class="action-button primary-button text-white px-4 py-2 rounded-xl font-medium text-sm">➕ Add Page</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md border border-gray-200">
                    <label for="importanceRating" class="text-gray-700 font-medium block mb-1">Importance:</label>
                    <div class="flex items-center gap-4">
                        <input type="range" id="importanceRating" min="1" max="10" value="5" class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"/>
                        <span id="importanceValue" class="font-semibold text-gray-700 w-8 text-right">5</span>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-2xl shadow-md border border-gray-200">
                    <label for="stickerNameInput" class="text-gray-700 font-medium block mb-1">Sticker Name:</label>
                    <input type="text" id="stickerNameInput" class="input-field w-full p-3 rounded-xl focus:outline-none text-sm" placeholder="Enter sticker name..." maxlength="30"/>
                </div>

                <div>
                    <div class="relative">
                         <label for="messageInput" class="text-gray-700 font-medium block mb-1 sr-only">Message Content:</label>
                        <textarea id="messageInput" class="input-field w-full p-4 rounded-2xl focus:outline-none resize-none" rows="4" placeholder="Enter your daily work message... 😊🚀"></textarea>
                        <div class="flex justify-between items-center mt-3">
                            <span id="charCount" class="text-sm text-gray-500 font-medium">0 characters</span>
                            <span id="messageCount" class="counter-badge">0/24 stickers</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <button id="saveButton" class="action-button primary-button w-full text-white px-6 py-4 rounded-2xl font-semibold text-lg transition-all duration-300" disabled>💾 Save Sticker</button>
                </div>
                <p id="debugMessage" class="text-sm text-red-500 p-3 bg-red-50 rounded-xl hidden"></p>
            </div>
            
            <div class="lg:col-span-3">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="currentStickerPageTitle" class="text-xl font-semibold text-gray-700">Your Stickers</h2>
                    <div class="flex items-center gap-2">
                        <input type="text" id="globalSearchInput" class="input-field p-2 rounded-xl focus:outline-none text-sm" placeholder="Search all stickers...">
                        <button id="globalSearchButton" class="action-button primary-button text-white px-3 py-2 rounded-xl text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="stickerDisplayArea">
                    <div id="stickerColumn1" class="space-y-4 min-h-[100px]"></div> 
                    <div id="stickerColumn2" class="space-y-4 min-h-[100px]"></div>
                    <div id="stickerColumn3" class="space-y-4 min-h-[100px]"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const messageInput = document.getElementById('messageInput');
        const stickerNameInput = document.getElementById('stickerNameInput');
        const importanceRating = document.getElementById('importanceRating');
        const importanceValue = document.getElementById('importanceValue');
        const saveButton = document.getElementById('saveButton');
        const stickerColumn1 = document.getElementById('stickerColumn1');
        const stickerColumn2 = document.getElementById('stickerColumn2');
        const stickerColumn3 = document.getElementById('stickerColumn3');
        const charCount = document.getElementById('charCount');
        const messageCount = document.getElementById('messageCount');
        const debugMessage = document.getElementById('debugMessage');
        const pagesContainer = document.getElementById('pagesContainer');
        const newPageNameInput = document.getElementById('newPageNameInput');
        const addPageButton = document.getElementById('addPageButton');
        const currentStickerPageTitle = document.getElementById('currentStickerPageTitle');
        const globalSearchInput = document.getElementById('globalSearchInput');
        const globalSearchButton = document.getElementById('globalSearchButton');
        const stickerDisplayArea = document.getElementById('stickerDisplayArea');

        let pages = {}; 
        let pageOrder = []; // NEW: For storing the order of pages
        let currentPage = 'default'; 
        const maxStickers = 24; 
        const stickerBgColors = [ 
            'sticker-bg-0', 'sticker-bg-1', 'sticker-bg-2', 'sticker-bg-3', 'sticker-bg-4',
            'sticker-bg-5', 'sticker-bg-6', 'sticker-bg-7', 'sticker-bg-8', 'sticker-bg-9',
            'sticker-bg-10', 'sticker-bg-11', 'sticker-bg-12', 'sticker-bg-13', 'sticker-bg-14', 'sticker-bg-15'
        ];
        const MAX_STICKER_LINES = 6; 
        let draggedStickerIndex = null; 
        let draggedStickerElement = null; // Keep track of the actual element being dragged
        let dropIndicator = null; // Element for the drop line indicator
        let draggedPageName = null; // For page drag and drop


        function getRandomStickerBgClass() { return stickerBgColors[Math.floor(Math.random() * stickerBgColors.length)]; }
        function getImportanceBorderClass(rating) { return `importance-level-${Math.max(1, Math.min(10, parseInt(rating)))}`; }

        function showNotification(messageText) { const notification = document.createElement('div'); notification.className = 'floating-notification'; notification.textContent = messageText; document.body.appendChild(notification); setTimeout(() => { notification.classList.add('hide'); setTimeout(() => notification.remove(), 400); }, 2000); }
        function showInputModal(title, placeholder, initialValue, maxLength, onSave, onCancel) { const overlay = document.createElement('div'); overlay.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50'; const modal = document.createElement('div'); modal.className = 'modal-content fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rounded-3xl p-8 max-w-md w-full mx-4'; modal.innerHTML = `<div class="text-center mb-6"><div class="w-16 h-16 mx-auto mb-4 bg-blue-100 rounded-full flex items-center justify-center"><span class="text-2xl">📝</span></div><h3 class="text-xl font-semibold text-gray-800 mb-2">${title}</h3><p class="text-gray-600 text-sm mb-4">Enter a name for your item</p><input type="text" id="modalInput" class="input-field w-full p-3 rounded-xl focus:outline-none" placeholder="${placeholder}" maxlength="${maxLength}"/><p class="text-xs text-gray-500 mt-2">Max ${maxLength} characters</p></div><div class="flex space-x-3"><button class="cancel-button action-button flex-1 text-white px-4 py-3 rounded-xl font-medium">Cancel</button><button class="primary-button action-button flex-1 text-white px-4 py-3 rounded-xl font-medium">Save</button></div>`; overlay.appendChild(modal); document.body.appendChild(overlay); const inputField = modal.querySelector('#modalInput'); const saveBtn = modal.querySelector('.primary-button'); const cancelBtn = modal.querySelector('.cancel-button'); inputField.value = initialValue; inputField.focus(); inputField.select(); saveBtn.addEventListener('click', () => { const value = inputField.value.trim(); if (value) { onSave(value); overlay.remove(); } else { inputField.focus(); inputField.style.borderColor = '#ef4444'; setTimeout(() => inputField.style.borderColor = '', 2000); } }); cancelBtn.addEventListener('click', () => { onCancel(); overlay.remove(); }); overlay.addEventListener('click', (e) => { if (e.target === overlay) { onCancel(); overlay.remove(); } }); inputField.addEventListener('keypress', (e) => { if (e.key === 'Enter') saveBtn.click(); }); }
        function showEditStickerModal(stickerData, onSave, onCancel) { const overlay = document.createElement('div'); overlay.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-[100]'; const modal = document.createElement('div'); modal.className = 'modal-content edit-sticker-modal-content fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rounded-3xl p-6 sm:p-8 shadow-2xl'; modal.innerHTML = `<div><h3 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Edit Sticker</h3><div class="mb-4"><label for="editStickerNameInput" class="block text-sm font-medium text-gray-700 mb-1">Name:</label><input type="text" id="editStickerNameInput" class="input-field w-full p-3 rounded-xl focus:outline-none text-sm" value="${stickerData.name}" maxlength="30"></div><div class="mb-4"><label for="editStickerContentInput" class="block text-sm font-medium text-gray-700 mb-1">Content:</label><textarea id="editStickerContentInput" class="input-field w-full p-3 rounded-xl focus:outline-none resize-y text-sm" rows="8">${stickerData.content}</textarea></div><div class="mb-6"><label for="editStickerImportanceInput" class="block text-sm font-medium text-gray-700 mb-1">Importance:</label><div class="flex items-center gap-3"><input type="range" id="editStickerImportanceInput" min="1" max="10" value="${stickerData.importance}" class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"><span id="editStickerImportanceValue" class="font-semibold text-gray-700 w-8 text-right">${stickerData.importance}</span></div></div><div class="flex flex-col sm:flex-row gap-3"><button id="editModalCancelButton" class="cancel-button action-button flex-1 text-white px-4 py-3 rounded-xl font-medium">Cancel</button><button id="editModalSaveButton" class="save-edit-button action-button flex-1 text-white px-4 py-3 rounded-xl font-medium">Save Changes</button></div></div>`; overlay.appendChild(modal); document.body.appendChild(overlay); document.body.style.overflow = 'hidden'; const nameInput = modal.querySelector('#editStickerNameInput'); const contentInput = modal.querySelector('#editStickerContentInput'); const importanceInput = modal.querySelector('#editStickerImportanceInput'); const importanceValueDisplay = modal.querySelector('#editStickerImportanceValue'); const saveBtn = modal.querySelector('#editModalSaveButton'); const cancelBtn = modal.querySelector('#editModalCancelButton'); importanceInput.addEventListener('input', () => { importanceValueDisplay.textContent = importanceInput.value; }); saveBtn.addEventListener('click', () => { const newName = nameInput.value.trim(); const newContent = contentInput.value.trim(); const newImportance = parseInt(importanceInput.value, 10); if (newName && newContent) { onSave({ name: newName, content: newContent, importance: newImportance }); document.body.style.overflow = ''; overlay.remove(); } else { showNotification('Name and content cannot be empty.'); } }); const closeModal = () => { document.body.style.overflow = ''; overlay.remove(); onCancel(); }; cancelBtn.addEventListener('click', closeModal); overlay.addEventListener('click', (e) => { if (e.target === overlay) closeModal(); }); nameInput.focus(); }
        function showDeleteConfirmationModal(itemType, itemName, onDeleteConfirm) { const overlay = document.createElement('div'); overlay.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50'; const modal = document.createElement('div'); modal.className = 'modal-content fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rounded-3xl p-8 max-w-sm w-full mx-4 text-center'; modal.innerHTML = `<div class="mb-6"><div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center"><span class="text-2xl">🗑️</span></div><h3 class="text-xl font-semibold text-gray-800 mb-2">Delete ${itemType}</h3><p class="text-gray-600">Are you sure you want to delete "${itemName}"? This action cannot be undone.</p></div><div class="flex space-x-3"><button class="cancel-button action-button flex-1 text-white px-4 py-3 rounded-xl font-medium">Cancel</button><button class="delete-button action-button flex-1 text-white px-4 py-3 rounded-xl font-medium">Delete</button></div>`; overlay.appendChild(modal); document.body.appendChild(overlay); const deleteButton = modal.querySelector('.delete-button'); const cancelButton = modal.querySelector('.cancel-button'); deleteButton.addEventListener('click', () => { onDeleteConfirm(); overlay.remove(); showNotification(`${itemType} deleted successfully!`); }); cancelButton.addEventListener('click', () => overlay.remove()); overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); }); }
        async function copyToClipboard(text, element) { if (document.querySelector('.modal-overlay') || element.dataset.isEditing === 'true') { if (element.dataset.isEditing === 'true') showNotification('Cannot copy while editing.'); return; } try { if (navigator.clipboard && window.isSecureContext) { await navigator.clipboard.writeText(text); showNotification('Sticker content copied! 📋'); } else { const textarea = document.createElement('textarea'); textarea.value = text; document.body.appendChild(textarea); textarea.select(); try { document.execCommand('copy'); showNotification('Sticker content copied! 📋'); } catch (err) { throw new Error('Fallback copy failed'); } finally { document.body.removeChild(textarea); } } } catch (err) { console.error('Failed to copy:', err); debugMessage.textContent = 'Copy failed. Ensure page is HTTPS or try another browser.'; debugMessage.classList.remove('hidden'); setTimeout(() => { debugMessage.classList.add('hidden'); }, 3000); } }

        function loadAllData() { 
            const storedPages = localStorage.getItem('stickerPages'); 
            if (storedPages) pages = JSON.parse(storedPages); 
            else pages['default'] = []; 
            
            const storedPageOrder = localStorage.getItem('stickerPageOrder');
            if (storedPageOrder) {
                pageOrder = JSON.parse(storedPageOrder);
                // Ensure pageOrder is consistent with pages keys
                const pageKeys = Object.keys(pages);
                pageOrder = pageOrder.filter(pName => pageKeys.includes(pName));
                pageKeys.forEach(pKey => {
                    if (!pageOrder.includes(pKey)) pageOrder.push(pKey); // Add any missing pages
                });
            } else {
                pageOrder = Object.keys(pages); // Default order if none saved
            }

            currentPage = localStorage.getItem('currentPage') || (pageOrder.length > 0 ? pageOrder[0] : 'default'); 
            if (!pages[currentPage]) { 
                currentPage = pageOrder.length > 0 ? pageOrder[0] : 'default'; 
                if (!pages[currentPage] && currentPage === 'default' && !pageOrder.includes('default')) {
                     pages['default'] = []; 
                     if(!pageOrder.includes('default')) pageOrder.push('default');
                }
            } 
            updateUI(); 
        }
        function saveAllData() { 
            localStorage.setItem('stickerPages', JSON.stringify(pages)); 
            localStorage.setItem('stickerPageOrder', JSON.stringify(pageOrder)); // Save page order
            localStorage.setItem('currentPage', currentPage); 
        }
        function addPage(pageName) { if (pages[pageName]) { showNotification(`Page "${pageName}" already exists!`); return; } pages[pageName] = []; if(!pageOrder.includes(pageName)) pageOrder.push(pageName); currentPage = pageName; saveAllData(); updateUI(); showNotification(`Page "${pageName}" created! 🎉`); }
        function switchPage(pageName) { if (currentPage === pageName) return; currentPage = pageName; saveAllData(); updateUI(); showNotification(`Switched to page: "${pageName}"`); globalSearchInput.value = ''; }
        function editPageName(oldPageName) { showInputModal('Edit Page Name', 'Enter new page name...', oldPageName, 20, (newPageName) => { if (newPageName === oldPageName) { showNotification('Page name not changed.'); return; } if (pages[newPageName]) { showNotification(`Page "${newPageName}" already exists!`); return; } const pageMessages = pages[oldPageName]; delete pages[oldPageName]; pages[newPageName] = pageMessages; const oldIndex = pageOrder.indexOf(oldPageName); if(oldIndex > -1) pageOrder.splice(oldIndex, 1, newPageName); else pageOrder.push(newPageName); if (currentPage === oldPageName) currentPage = newPageName; saveAllData(); updateUI(); showNotification(`Page "${oldPageName}" renamed to "${newPageName}"!`); }, () => {}); }
        function deletePage(pageName) { showDeleteConfirmationModal('Page', pageName, () => { delete pages[pageName]; pageOrder = pageOrder.filter(p => p !== pageName); if (pageOrder.length === 0) { pages['default'] = []; pageOrder.push('default'); } if (currentPage === pageName) currentPage = pageOrder[0] || 'default'; saveAllData(); updateUI(); }); }
        
        function renderPages() { 
            pagesContainer.innerHTML = ''; 
            // Use pageOrder for rendering
            pageOrder.forEach(pageName => { 
                if (!pages[pageName]) return; // Skip if page data doesn't exist for some reason
                const pageButton = document.createElement('button'); 
                pageButton.className = `action-button px-4 py-2 rounded-xl font-medium text-sm transition-all duration-200 ${currentPage === pageName ? 'primary-button text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`; 
                pageButton.textContent = pageName; 
                pageButton.dataset.pageName = pageName; // For drag/drop
                pageButton.setAttribute('draggable', 'true'); // Make page button draggable

                pageButton.addEventListener('click', () => switchPage(pageName)); 
                pageButton.addEventListener('contextmenu', (e) => { e.preventDefault(); showPageContextMenu(e.clientX, e.clientY, pageName); }); 
                
                // Page Drag and Drop Listeners
                pageButton.addEventListener('dragstart', handlePageDragStart);
                pageButton.addEventListener('dragover', handlePageDragOver);
                pageButton.addEventListener('dragleave', handlePageDragLeave);
                pageButton.addEventListener('drop', handlePageDrop);
                pageButton.addEventListener('dragend', handlePageDragEnd);

                pagesContainer.appendChild(pageButton); 
            }); 
        }
        function showPageContextMenu(x, y, pageName) { const existingMenu = document.getElementById('pageContextMenu'); if (existingMenu) existingMenu.remove(); const menu = document.createElement('div'); menu.id = 'pageContextMenu'; menu.className = 'absolute bg-white rounded-lg shadow-lg py-2 z-50 text-sm'; menu.style.left = `${x}px`; menu.style.top = `${y}px`; menu.style.minWidth = '120px'; const editItem = document.createElement('button'); editItem.className = 'block w-full text-left px-4 py-2 hover:bg-gray-100'; editItem.textContent = 'Edit Name'; editItem.addEventListener('click', () => { editPageName(pageName); menu.remove(); }); const deleteItem = document.createElement('button'); deleteItem.className = 'block w-full text-left px-4 py-2 text-red-600 hover:bg-red-50'; deleteItem.textContent = 'Delete Page'; deleteItem.addEventListener('click', () => { deletePage(pageName); menu.remove(); }); menu.appendChild(editItem); if (pageOrder.length > 1) menu.appendChild(deleteItem); document.body.appendChild(menu); const closeMenu = (event) => { if (!menu.contains(event.target)) { menu.remove(); document.removeEventListener('click', closeMenu); document.removeEventListener('contextmenu', closeMenu); } }; setTimeout(() => { document.addEventListener('click', closeMenu); document.addEventListener('contextmenu', closeMenu); }, 0); }

        // --- Sticker Drag and Drop Handlers ---
        function handleDragStart(event) {
            draggedStickerElement = event.target;
            draggedStickerIndex = parseInt(draggedStickerElement.dataset.index);
            draggedStickerElement.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', draggedStickerIndex);
            
            if (!dropIndicator) {
                dropIndicator = document.createElement('div');
                dropIndicator.className = 'drop-indicator-line';
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            const targetSticker = event.target.closest('.sticker-note');
            const column = event.target.closest('.space-y-4'); // space-y-4 is on columns now

            if (targetSticker && targetSticker !== draggedStickerElement) {
                const rect = targetSticker.getBoundingClientRect();
                const isAfter = event.clientY > rect.top + rect.height / 2;
                if (isAfter) {
                    targetSticker.parentNode.insertBefore(dropIndicator, targetSticker.nextSibling);
                } else {
                    targetSticker.parentNode.insertBefore(dropIndicator, targetSticker);
                }
            } else if (column && !targetSticker) { // Dragging over empty part of a column
                const lastChild = column.lastElementChild;
                if (lastChild && lastChild.classList.contains('sticker-note')) {
                     column.insertBefore(dropIndicator, null); // Append to end of column
                } else if (!lastChild) { // Column is empty
                    column.appendChild(dropIndicator);
                }
            }
        }
        
        function handleDragLeave(event) {
            // More robust removal if the mouse leaves the general sticker area
            if (dropIndicator && dropIndicator.parentNode && !event.currentTarget.contains(event.relatedTarget)) {
                 if (dropIndicator.parentNode) dropIndicator.remove();
            }
        }

        function handleDrop(event) {
            event.preventDefault();
            if (draggedStickerIndex === null || !dropIndicator || !dropIndicator.parentNode) {
                if(draggedStickerElement) draggedStickerElement.classList.remove('dragging');
                if(dropIndicator && dropIndicator.parentNode) dropIndicator.remove();
                draggedStickerIndex = null;
                draggedStickerElement = null;
                return;
            }

            const stickersInPage = pages[currentPage];
            const stickerToMove = stickersInPage.splice(draggedStickerIndex, 1)[0];
            
            const children = Array.from(dropIndicator.parentNode.children);
            let newIndex = children.indexOf(dropIndicator);

            // Adjust newIndex if dropIndicator was placed after the dragged element's original position
            const originalPositionInColumn = children.indexOf(draggedStickerElement);
            if (draggedStickerElement.parentNode === dropIndicator.parentNode && originalPositionInColumn < newIndex) {
                 // If dragging down within the same column, the newIndex is effectively one less after removal
            }


            // Determine the actual overall index in the `pages[currentPage]` array
            // This requires knowing which column it was dropped into and its position within that column
            const targetColumn = dropIndicator.parentNode;
            let overallNewIndex = 0;
            if (targetColumn === stickerColumn1) {
                overallNewIndex = newIndex;
            } else if (targetColumn === stickerColumn2) {
                overallNewIndex = (pages[currentPage].filter((s,i) => i < 8).length) + newIndex;
                 // This logic needs to be more precise based on actual items in columns before this one
                 overallNewIndex = stickerColumn1.children.length - (stickerColumn1.contains(dropIndicator) ? 1 : 0) + newIndex;


            } else if (targetColumn === stickerColumn3) {
                 overallNewIndex = (pages[currentPage].filter((s,i) => i < 16).length) + newIndex;
                 overallNewIndex = (stickerColumn1.children.length - (stickerColumn1.contains(dropIndicator) ? 1 : 0)) + 
                                  (stickerColumn2.children.length - (stickerColumn2.contains(dropIndicator) ? 1 : 0)) + newIndex;
            }
             // Simplified approach: find index based on elements before the indicator in the whole list
            const allStickerElements = Array.from(stickerDisplayArea.querySelectorAll('.sticker-note:not(.dragging)'));
            let insertAtIndex = 0;
            for(let i=0; i < allStickerElements.length; i++){
                if(allStickerElements[i].parentNode === dropIndicator.parentNode && allStickerElements[i].compareDocumentPosition(dropIndicator) & Node.DOCUMENT_POSITION_PRECEDING){
                    insertAtIndex++;
                } else if (allStickerElements[i].parentNode !== dropIndicator.parentNode) {
                    // This logic is tricky with columns. For now, let's simplify.
                    // The drop indicator's position relative to its siblings is key.
                }
            }
            // Find the element before which the indicator was placed
            let siblingAfterIndicator = dropIndicator.nextElementSibling;
            let insertBeforeIndex = stickersInPage.length; // Default to end

            if (siblingAfterIndicator && siblingAfterIndicator.dataset.index) {
                insertBeforeIndex = parseInt(siblingAfterIndicator.dataset.index);
                 // If dragged element was before this, and we are moving it after, adjust
                if (draggedStickerIndex < insertBeforeIndex) {
                   // insertBeforeIndex--; // This might be needed if dragged from before
                }
            } else if (dropIndicator.parentNode.contains(dropIndicator) && !siblingAfterIndicator) {
                // Dropped at the end of a column, which means end of the list for that column's range
                // This needs to be mapped to the overall list index
                // For simplicity now, if it's the last child, it's effectively the end.
            }


            let finalInsertIndex = 0;
            const parentCol = dropIndicator.parentElement;
            const siblings = Array.from(parentCol.children).filter(c => c.classList.contains('sticker-note') || c === dropIndicator);
            const indicatorPosInCol = siblings.indexOf(dropIndicator);

            if (parentCol === stickerColumn1) {
                finalInsertIndex = indicatorPosInCol;
            } else if (parentCol === stickerColumn2) {
                finalInsertIndex = stickerColumn1.querySelectorAll('.sticker-note').length + indicatorPosInCol;
            } else if (parentCol === stickerColumn3) {
                finalInsertIndex = stickerColumn1.querySelectorAll('.sticker-note').length + stickerColumn2.querySelectorAll('.sticker-note').length + indicatorPosInCol;
            }


            stickersInPage.splice(finalInsertIndex, 0, stickerToMove);
            
            saveAllData();
            updateStickerList(); 
            
            if(draggedStickerElement) draggedStickerElement.classList.remove('dragging');
            if(dropIndicator && dropIndicator.parentNode) dropIndicator.remove();
            draggedStickerIndex = null;
            draggedStickerElement = null;
        }
        
        function handleDragEnd(event) {
            if(draggedStickerElement) draggedStickerElement.classList.remove('dragging');
            if(dropIndicator && dropIndicator.parentNode) dropIndicator.remove();
            draggedStickerIndex = null;
            draggedStickerElement = null;
        }


        function updateStickerList() {
            stickerColumn1.innerHTML = ''; stickerColumn2.innerHTML = ''; stickerColumn3.innerHTML = '';
            const currentStickers = pages[currentPage] || [];
            currentStickers.forEach((stickerObj, index) => {
                const stickerContainer = document.createElement('div');
                stickerContainer.dataset.isEditing = 'false'; 
                stickerContainer.dataset.index = index; 
                stickerContainer.dataset.stickerId = `${currentPage}-${index}`; // Unique ID for highlighting
                stickerContainer.setAttribute('draggable', 'true'); 

                stickerContainer.className = `sticker-note relative p-4 rounded-xl shadow-md ${stickerObj.bgColorClass} ${getImportanceBorderClass(stickerObj.importance)}`;
                
                stickerContainer.addEventListener('dragstart', handleDragStart);
                stickerContainer.addEventListener('dragover', handleDragOver); // Moved to column for better indicator
                stickerContainer.addEventListener('dragleave', handleDragLeave); // Moved to column
                stickerContainer.addEventListener('drop', handleDrop);      // Drop on sticker itself
                stickerContainer.addEventListener('dragend', handleDragEnd);

                stickerContainer.addEventListener('click', (e) => { if (!e.target.closest('.sticker-actions button') && stickerContainer.dataset.isEditing === 'false' && !stickerContainer.classList.contains('dragging')) { copyToClipboard(stickerObj.content, stickerContainer); } });
                const headerDiv = document.createElement('div'); headerDiv.className = "flex justify-between items-start mb-1"; headerDiv.innerHTML = `<div class="font-semibold text-gray-800 text-sm truncate pr-16 pointer-events-none">${stickerObj.name}</div>`; stickerContainer.appendChild(headerDiv);
                const contentArea = document.createElement('div'); contentArea.className = "flex-grow overflow-hidden mb-1 pointer-events-none"; const contentText = document.createElement('div'); contentText.className = 'sticker-content-text text-sm text-gray-700 h-full'; const lines = stickerObj.content.split('\n');
                if (lines.length > MAX_STICKER_LINES) { const lastVisibleLine = lines[MAX_STICKER_LINES -1]; contentText.textContent = lines.slice(0, MAX_STICKER_LINES-1).join('\n') + '\n' + lastVisibleLine + ' ...'; } else { contentText.textContent = stickerObj.content; }
                contentArea.appendChild(contentText); stickerContainer.appendChild(contentArea);
                const timestampDiv = document.createElement('div'); timestampDiv.className = 'sticker-timestamp pointer-events-none'; const date = new Date(stickerObj.timestamp); const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`; const formattedTime = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }); timestampDiv.textContent = `${formattedDate} ${formattedTime}`; stickerContainer.appendChild(timestampDiv);
                const actionsDiv = document.createElement('div'); actionsDiv.className = 'sticker-actions'; actionsDiv.innerHTML = `<button class="edit-button action-button text-white px-2 py-1 rounded-lg font-medium text-xs">Edit</button><button class="delete-button action-button text-white px-2 py-1 rounded-lg font-medium text-xs">Del</button>`; stickerContainer.appendChild(actionsDiv);
                stickerContainer.querySelector('.edit-button').addEventListener('click', (e) => { e.stopPropagation(); editSticker(index, stickerContainer); });
                stickerContainer.querySelector('.delete-button').addEventListener('click', (e) => { e.stopPropagation(); showDeleteConfirmationModal('Sticker', stickerObj.name, () => deleteSticker(index)); });
                
                if (index < 8) stickerColumn1.appendChild(stickerContainer);
                else if (index < 16) stickerColumn2.appendChild(stickerContainer);
                else stickerColumn3.appendChild(stickerContainer);
            });
            
            [stickerColumn1, stickerColumn2, stickerColumn3].forEach(column => {
                column.addEventListener('dragover', handleDragOver); 
                column.addEventListener('dragleave', handleDragLeave);
                column.addEventListener('drop', handleDrop); // Allow dropping onto column (will use indicator)
            });

            messageCount.textContent = `${currentStickers.length}/${maxStickers} stickers`;
            updateSaveButtonState();
        }
        
        function editSticker(index, stickerElement) { stickerElement.dataset.isEditing = 'true'; const currentSticker = pages[currentPage][index]; showEditStickerModal(currentSticker, (updatedData) => { pages[currentPage][index] = { ...currentSticker, name: updatedData.name, content: updatedData.content, importance: updatedData.importance, timestamp: Date.now(), }; saveAllData(); updateStickerList(); showNotification('Sticker updated! ✨'); }, () => { stickerElement.dataset.isEditing = 'false'; updateUI(); }); }
        function deleteSticker(index) { pages[currentPage].splice(index, 1); saveAllData(); updateStickerList(); }
        function updateSaveButtonState() { const messageLength = messageInput.value.trim().length; const nameLength = stickerNameInput.value.trim().length; const currentStickers = pages[currentPage] || []; saveButton.disabled = messageLength === 0 || nameLength === 0 || currentStickers.length >= maxStickers; }

        messageInput.addEventListener('input', () => { charCount.textContent = `${messageInput.value.length} characters`; updateSaveButtonState(); });
        stickerNameInput.addEventListener('input', updateSaveButtonState);
        importanceRating.addEventListener('input', () => { importanceValue.textContent = importanceRating.value; });
        saveButton.addEventListener('click', () => { const message = messageInput.value.trim(); const name = stickerNameInput.value.trim(); const importance = parseInt(importanceRating.value, 10); const currentStickers = pages[currentPage] || []; if (name && message && currentStickers.length < maxStickers) { const stickerObj = { name, content: message, importance, timestamp: Date.now(), bgColorClass: getRandomStickerBgClass() }; if (!pages[currentPage]) pages[currentPage] = []; pages[currentPage].push(stickerObj); saveAllData(); messageInput.value = ''; stickerNameInput.value = ''; importanceRating.value = 5; importanceValue.textContent = 5; charCount.textContent = `0 characters`; updateUI(); showNotification('Sticker saved! ✨'); } else if (currentStickers.length >= maxStickers) { showNotification('Maximum sticker limit reached for this page.'); } else if (!name) { showNotification('Sticker name cannot be empty.'); stickerNameInput.focus(); } else if (!message) { showNotification('Message content cannot be empty.'); messageInput.focus(); } });
        addPageButton.addEventListener('click', () => { const newPageName = newPageNameInput.value.trim(); if (newPageName) { addPage(newPageName); newPageNameInput.value = ''; } else { showNotification('Page name cannot be empty.'); } });
        newPageNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addPageButton.click(); });

        // --- Page Drag and Drop Handlers ---
        let pageDropIndicator = null;
        function handlePageDragStart(event) {
            draggedPageName = event.target.dataset.pageName;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', draggedPageName);
            if (!pageDropIndicator) {
                pageDropIndicator = document.createElement('div');
                pageDropIndicator.className = 'page-drop-indicator-line';
            }
        }
        function handlePageDragOver(event) {
            event.preventDefault();
            const targetPageButton = event.target.closest('#pagesContainer .action-button');
            if (targetPageButton && targetPageButton.dataset.pageName !== draggedPageName) {
                const rect = targetPageButton.getBoundingClientRect();
                const isAfter = event.clientX > rect.left + rect.width / 2; // For horizontal
                if (isAfter) {
                    pagesContainer.insertBefore(pageDropIndicator, targetPageButton.nextSibling);
                } else {
                    pagesContainer.insertBefore(pageDropIndicator, targetPageButton);
                }
            } else if (!targetPageButton && event.currentTarget === pagesContainer) {
                // Dragging over empty part of pagesContainer
                pagesContainer.appendChild(pageDropIndicator);
            }
        }
        function handlePageDragLeave(event) {
            if (pageDropIndicator && pageDropIndicator.parentNode && !event.currentTarget.contains(event.relatedTarget)) {
                pageDropIndicator.remove();
            }
        }
        function handlePageDrop(event) {
            event.preventDefault();
            if (!draggedPageName || !pageDropIndicator || !pageDropIndicator.parentNode) {
                if(pageDropIndicator && pageDropIndicator.parentNode) pageDropIndicator.remove();
                const draggingElem = pagesContainer.querySelector(`.action-button[data-page-name="${draggedPageName}"]`);
                if(draggingElem) draggingElem.classList.remove('dragging');
                draggedPageName = null;
                return;
            }

            const oldIndex = pageOrder.indexOf(draggedPageName);
            pageOrder.splice(oldIndex, 1); // Remove from old position

            const buttons = Array.from(pagesContainer.children).filter(c => c.classList.contains('action-button') || c === pageDropIndicator);
            let newIndex = buttons.indexOf(pageDropIndicator);
            
            pageOrder.splice(newIndex, 0, draggedPageName); // Insert at new position

            saveAllData();
            renderPages(); // Re-render with new order

            if(pageDropIndicator && pageDropIndicator.parentNode) pageDropIndicator.remove();
            const finalDraggingElem = pagesContainer.querySelector(`.action-button[data-page-name="${draggedPageName}"]`);
            if(finalDraggingElem) finalDraggingElem.classList.remove('dragging');
            draggedPageName = null;
        }
        function handlePageDragEnd(event) {
            if(pageDropIndicator && pageDropIndicator.parentNode) pageDropIndicator.remove();
            const elem = event.target.closest('.action-button');
            if(elem) elem.classList.remove('dragging');
            draggedPageName = null;
        }


        // --- Global Search Functions ---
        function performGlobalSearch() { const searchTerm = globalSearchInput.value.trim().toLowerCase(); if (!searchTerm) { showNotification("Please enter a search term."); return; } const results = []; pageOrder.forEach(pageName => { if(pages[pageName]) { pages[pageName].forEach((sticker, index) => { if (sticker.name.toLowerCase().includes(searchTerm) || sticker.content.toLowerCase().includes(searchTerm)) { results.push({ ...sticker, pageName, originalIndex: index, stickerId: `${pageName}-${index}` }); } }); } }); displaySearchResultsModal(results, searchTerm); }
        function displaySearchResultsModal(results, searchTerm) {
            const existingModal = document.getElementById('searchResultsModal'); if(existingModal) existingModal.remove();
            const overlay = document.createElement('div'); overlay.id = 'searchResultsModal'; overlay.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-[100]';
            const modal = document.createElement('div'); modal.className = 'modal-content search-results-modal-content fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rounded-3xl p-6 sm:p-8 shadow-2xl';
            let resultsHTML = '';
            if (results.length > 0) {
                results.forEach(sticker => {
                    const date = new Date(sticker.timestamp); const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`; const formattedTime = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }); const displayTimestamp = `${formattedDate} ${formattedTime}`;
                    let displayName = sticker.name; let displayContent = sticker.content;
                    const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    displayName = displayName.replace(regex, '<mark class="bg-yellow-200 rounded">$1</mark>');
                    // Don't truncate content here, let CSS handle scroll
                    // displayContent = displayContent.replace(regex, '<mark class="bg-yellow-200 rounded">$1</mark>');

                    resultsHTML += `
                        <div class="search-result-item ${getImportanceBorderClass(sticker.importance)} border-l-4 pl-3" data-target-page="${sticker.pageName}" data-sticker-id="${sticker.stickerId}">
                            <h4 class="font-semibold text-lg text-gray-800 mb-1">${displayName}</h4>
                            <p class="text-xs text-gray-500 mb-1">On page: ${sticker.pageName}</p>
                            <div class="search-result-content text-sm text-gray-700 mb-2 whitespace-pre-wrap scrollbar-custom">${sticker.content.replace(regex, '<mark class="bg-yellow-200 rounded">$1</mark>')}</div>
                            <p class="text-xs text-gray-500 text-right">${displayTimestamp}</p>
                        </div>`;
                });
            } else { resultsHTML = '<p class="text-gray-600 text-center py-4">No stickers found matching your search.</p>'; }
            modal.innerHTML = `<div><div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-semibold text-gray-800">Search Results</h3><button id="closeSearchModalButton" class="text-gray-500 hover:text-gray-700"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></button></div><div class="search-modal-body scrollbar-custom pr-2">${resultsHTML}</div></div>`;
            overlay.appendChild(modal); document.body.appendChild(overlay); document.body.style.overflow = 'hidden';
            
            modal.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', () => {
                    const targetPage = item.dataset.targetPage;
                    const targetStickerId = item.dataset.stickerId;
                    switchPage(targetPage); // This will call updateUI
                    // Wait for UI to update then highlight
                    setTimeout(() => {
                        const stickerElement = document.querySelector(`.sticker-note[data-sticker-id="${targetStickerId}"]`);
                        if (stickerElement) {
                            stickerElement.classList.add('sticker-highlight-effect');
                            stickerElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            setTimeout(() => {
                                stickerElement.classList.remove('sticker-highlight-effect');
                            }, 1100); // немного дольше, чем анимация
                        }
                    }, 100); // Small delay for UI update
                    document.body.style.overflow = ''; overlay.remove();
                });
            });
            modal.querySelector('#closeSearchModalButton').addEventListener('click', () => { document.body.style.overflow = ''; overlay.remove(); });
        }

        globalSearchButton.addEventListener('click', performGlobalSearch);
        globalSearchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') performGlobalSearch(); });

        function updateUI() { if (!pages[currentPage] && pageOrder.length > 0) { currentPage = pageOrder[0]; } else if (!pages[currentPage]) { currentPage = 'default'; if(!pageOrder.includes('default')) pageOrder.push('default'); if(!pages.default) pages.default = []; } saveAllData(); renderPages(); updateStickerList(); const pageTitle = currentPage.charAt(0).toUpperCase() + currentPage.slice(1); currentStickerPageTitle.textContent = `${pageTitle} Stickers`; updateSaveButtonState(); }
        loadAllData();
    </script>
</body>
</html>
